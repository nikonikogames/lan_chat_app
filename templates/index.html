<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LANチャット</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
</head>
<body>
  <div id="login">
    <h2>ユーザー名を入力してください</h2>
    <input type="text" id="username">
    <button id="loginButton" class="rounded">開始</button>
  </div>

  <div id="chat" style="display:none;">
    <div id="chat-box"></div>
    <input type="text" id="message">
    <button onclick="sendMessage()" class="rounded">送信</button>
    <button onclick="logout()" class="rounded">ログアウト</button>
    <button onclick="changeUsername()" class="rounded">名前変更</button>
    <button onclick="deleteChat()" class="rounded">チャット削除</button>
  </div>

  <script>
    const socket = io();
    let username = localStorage.getItem('chatUsername') || "";

    function login() {
      username = document.getElementById("username").value.trim();
      if (username) {
        localStorage.setItem('chatUsername', username);
        document.getElementById("login").style.display = "none";
        document.getElementById("chat").style.display = "block";
        socket.emit('request history');
      }
    }

    document.getElementById("loginButton").addEventListener("click", login);

    function logout() {
      localStorage.removeItem('chatUsername');
      location.reload();
    }

    function changeUsername() {
      const newName = prompt("新しい名前を入力:", username);
      if (newName) {
        username = newName;
        localStorage.setItem('chatUsername', username);
      }
    }

    function sendMessage() {
      const msg = document.getElementById("message").value.trim();
      if (msg) {
        socket.emit('message', { user: username, text: msg });
        document.getElementById("message").value = '';
      }
    }

    function deleteChat() {
      const pw = prompt("パスワードを入力:");
      if (pw === "0826") {
        fetch('/clear', { method: 'POST' }).then(() => {
          document.getElementById("chat-box").innerHTML = "";
        });
      } else {
        alert("パスワードが間違っています");
      }
    }

    function escapeHTML(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function parseMessageText(text) {
      const urlPattern = /(https?:\/\/[^\x00-\x20"<>]*)/g;
      return text.split(urlPattern).map(segment => {
        if (segment.match(urlPattern)) {
          return `<a href="https://www-google-com.translate.goog/?_x_tr_sl=en&_x_tr_tl=ja&_x_tr_hl=ja&_x_tr_pto=wapp&_x_tr_hist=true&u=${encodeURIComponent(segment)}" target="_blank" class="chat-link" data-url="${segment}">${segment}</a>`;
        } else {
          return escapeHTML(segment);
        }
      }).join('');
    }

    socket.on('message', data => {
      addMessage(data);
    });

    socket.on('history', history => {
      document.getElementById("chat-box").innerHTML = "";
      history.forEach(data => addMessage(data));
    });

    function addMessage(data) {
      const box = document.getElementById("chat-box");
      const div = document.createElement("div");
      div.className = data.user === username ? 'bubble me' : 'bubble you';
      div.innerHTML = `<b>${escapeHTML(data.user)}</b>: ${parseMessageText(data.text)}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    if (username) {
      document.getElementById("username").value = username;
      login();
    }
  </script>
</body>
</html>
